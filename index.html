<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceFlow - Smart Money Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141b3d;
            --bg-card: #1a2149;
            --text-primary: #ffffff;
            --text-secondary: #a5b4fc;
            --text-muted: #6b7b9e;
            --accent-primary: #00d4ff;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --accent-info: #3b82f6;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --gradient-5: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-gradient {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.15;
            animation: float 20s infinite ease-in-out;
        }

        .bg-gradient:nth-child(1) {
            width: 600px;
            height: 600px;
            top: -200px;
            left: -200px;
            background: var(--gradient-1);
            animation-delay: 0s;
        }

        .bg-gradient:nth-child(2) {
            width: 500px;
            height: 500px;
            top: 30%;
            right: -150px;
            background: var(--gradient-3);
            animation-delay: 5s;
        }

        .bg-gradient:nth-child(3) {
            width: 400px;
            height: 400px;
            bottom: -100px;
            left: 50%;
            background: var(--gradient-4);
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(50px, -50px) scale(1.1); }
            66% { transform: translate(-30px, 30px) scale(0.9); }
        }

        /* Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 0 60px;
            position: relative;
        }

        .header-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.2);
        }

        .logo {
            font-family: 'Syne', sans-serif;
            font-size: 3.5em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -2px;
            animation: slideDown 0.8s ease-out;
        }

        .tagline {
            font-size: 1.2em;
            color: var(--text-secondary);
            font-weight: 300;
            animation: fadeIn 1s ease-out 0.3s both;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideDown 0.3s ease-out;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-family: 'Syne', sans-serif;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close-modal {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-danger);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: var(--accent-danger);
            color: white;
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-text {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .file-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: var(--bg-secondary);
        }

        .file-upload-area:hover {
            border-color: var(--accent-primary);
            background: var(--bg-card);
        }

        .file-upload-area.dragover {
            border-color: var(--accent-primary);
            background: var(--bg-card);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--accent-success);
            padding: 15px 20px;
            border-radius: 12px;
            margin-top: 15px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .success-message.show {
            display: flex;
            animation: slideDown 0.3s ease-out;
        }

        .warning-message {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--accent-warning);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            line-height: 1.6;
        }

        /* Dashboard Cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 24px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .stat-card.income .stat-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }

        .stat-card.expenses .stat-icon {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
        }

        .stat-card.balance .stat-icon {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }

        .stat-card.savings .stat-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
            font-family: 'Syne', sans-serif;
        }

        .stat-change {
            font-size: 0.85em;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        /* Section Card */
        .section-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 35px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: fadeInUp 0.8s ease-out 0.6s both;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Syne', sans-serif;
            font-size: 1.6em;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-icon {
            font-size: 1.3em;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            gap: 20px;
        }

        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 2px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1em;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
            background: var(--bg-card);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        /* Button */
        .btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-full {
            width: 100%;
        }

        /* Transaction List */
        .transaction-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .transaction-list::-webkit-scrollbar {
            width: 6px;
        }

        .transaction-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .transaction-list::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 10px;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
            animation: slideInRight 0.5s ease-out;
        }

        .transaction-item:hover {
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .transaction-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .transaction-icon.income {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            color: var(--accent-success);
        }

        .transaction-icon.expense {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
            color: var(--accent-danger);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-name {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .transaction-category {
            font-size: 0.85em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transaction-date {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .transaction-amount {
            font-size: 1.3em;
            font-weight: 700;
            font-family: 'Syne', sans-serif;
            margin-right: 15px;
        }

        .transaction-amount.income {
            color: var(--accent-success);
        }

        .transaction-amount.expense {
            color: var(--accent-danger);
        }

        .delete-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-danger);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 600;
        }

        .delete-btn:hover {
            background: var(--accent-danger);
            color: white;
            transform: scale(1.05);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            animation: fadeInUp 0.8s ease-out 0.8s both;
        }

        .chart-container {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 35px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 400px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-text {
            font-size: 1.1em;
        }

        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: 500;
        }

        .filter-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-color: transparent;
        }

        .filter-tab:hover:not(.active) {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 2.5em;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 2em;
            }

            .section-card {
                padding: 25px;
            }

            .transaction-item {
                flex-wrap: wrap;
            }

            .filter-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
        }

        /* Budget Progress */
        .budget-item {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .budget-category {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .budget-amounts {
            text-align: right;
        }

        .budget-spent {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .budget-total {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: var(--bg-primary);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .progress-bar-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .progress-bar-fill.danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        /* Budget Management */
        .budget-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .budget-card:hover {
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateX(3px);
        }

        .budget-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .budget-edit-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--accent-info);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .budget-edit-btn:hover {
            background: var(--accent-info);
            color: white;
        }

        .budget-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .budget-stat {
            text-align: center;
        }

        .budget-stat-label {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .budget-stat-value {
            font-size: 1.2em;
            font-weight: 700;
            font-family: 'Syne', sans-serif;
        }

        /* Alert System */
        .alert-container {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 380px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .alert-container::-webkit-scrollbar {
            width: 4px;
        }

        .alert-container::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 10px;
        }

        .alert {
            background: var(--bg-card);
            border-left: 4px solid;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            animation: slideInFromRight 0.4s ease-out;
            position: relative;
        }

        .alert.warning {
            border-left-color: var(--accent-warning);
        }

        .alert.danger {
            border-left-color: var(--accent-danger);
        }

        .alert.info {
            border-left-color: var(--accent-info);
        }

        .alert.success {
            border-left-color: var(--accent-success);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .alert-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .alert-title {
            font-weight: 700;
            font-size: 1em;
            color: var(--text-primary);
        }

        .alert-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2em;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .alert-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .alert-message {
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.5;
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Comparison Chart */
        .comparison-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .comparison-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .comparison-values {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .comparison-value {
            font-weight: 700;
            font-family: 'Syne', sans-serif;
            font-size: 1.1em;
        }

        .comparison-change {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 8px;
        }

        .comparison-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
        }

        .comparison-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-danger);
        }

        .comparison-change.neutral {
            background: rgba(107, 123, 158, 0.1);
            color: var(--text-muted);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.05);
        }

        .tab-btn {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95em;
            position: relative;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--accent-primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* File Attachments */
        .attachment-input-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-secondary);
            margin-top: 10px;
        }

        .attachment-input-area:hover {
            border-color: var(--accent-primary);
            background: rgba(0, 212, 255, 0.05);
        }

        .attachment-input-area.has-files {
            border-color: var(--accent-success);
            background: rgba(16, 185, 129, 0.05);
        }

        .attachment-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .attachment-text {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .attachment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .attachment-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: var(--bg-secondary);
        }

        .attachment-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .attachment-item-doc {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            text-align: center;
        }

        .attachment-item-icon {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .attachment-item-name {
            font-size: 0.7em;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }

        .remove-attachment {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: var(--accent-danger);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .attachment-item:hover .remove-attachment {
            opacity: 1;
        }

        .transaction-attachments {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .transaction-attachment-badge {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--accent-info);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .transaction-attachment-badge:hover {
            background: var(--accent-info);
            color: white;
            transform: translateY(-2px);
        }

        /* Document Viewer Modal */
        .viewer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.98);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .viewer-modal.active {
            display: flex;
        }

        .viewer-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .viewer-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .viewer-close {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-danger);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .viewer-close:hover {
            background: var(--accent-danger);
            color: white;
            transform: rotate(90deg);
        }

        .viewer-body {
            max-height: 70vh;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .viewer-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
        }

        .viewer-navigation {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .viewer-nav-btn {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .viewer-nav-btn:hover:not(:disabled) {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .viewer-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .attachment-count {
            background: var(--accent-info);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 700;
            margin-left: 5px;
        }

        /* Search and Filter Bar */
        .search-filter-bar {
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 14px 45px 14px 45px;
            background: var(--bg-secondary);
            border: 2px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1em;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.2em;
            pointer-events: none;
        }

        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s;
            display: none;
        }

        .clear-search.visible {
            display: block;
        }

        .clear-search:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .advanced-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-select {
            padding: 10px 15px;
            background: var(--bg-secondary);
            border: 2px solid rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9em;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .filter-select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .active-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            animation: slideInRight 0.3s ease-out;
        }

        .filter-chip-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            transition: all 0.3s;
        }

        .filter-chip-close:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }

        .results-count {
            color: var(--text-muted);
            font-size: 0.9em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .clear-all-filters {
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-danger);
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .clear-all-filters:hover {
            background: var(--accent-danger);
            color: white;
        }

        .sort-options {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .sort-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sort-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .sort-btn:hover:not(.active) {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* AI Insights */
        .ai-insights-btn {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-insights-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.5);
        }

        .ai-insights-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .ai-insights-panel {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            margin-top: 25px;
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        .ai-insights-panel.active {
            display: block;
        }

        .ai-insights-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.2);
        }

        .ai-insights-title {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-badge {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.65em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ai-insights-content {
            color: var(--text-secondary);
            line-height: 1.8;
            font-size: 1em;
        }

        .ai-insights-content h3 {
            color: var(--text-primary);
            font-size: 1.2em;
            margin-top: 25px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-insights-content ul {
            margin: 15px 0;
            padding-left: 25px;
        }

        .ai-insights-content li {
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .ai-insights-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .ai-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px 20px;
            gap: 20px;
        }

        .ai-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ai-loading-text {
            color: var(--text-secondary);
            font-size: 1em;
        }

        .insight-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #8b5cf6;
        }

        .insight-card.warning {
            border-left-color: var(--accent-warning);
        }

        .insight-card.success {
            border-left-color: var(--accent-success);
        }

        .insight-card.info {
            border-left-color: var(--accent-info);
        }

        .privacy-notice {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .privacy-notice strong {
            color: #8b5cf6;
        }

        /* Category Details View */
        .category-detail-section {
            margin-top: 25px;
        }

        .category-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-detail-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }

        .category-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-detail-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-detail-total {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .month-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .month-btn {
            padding: 10px 15px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }

        .month-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .month-btn:hover:not(.active) {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .category-transactions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .category-transaction-item {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }

        .category-transaction-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(5px);
        }

        .category-transaction-info {
            flex: 1;
        }

        .category-transaction-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .category-transaction-date {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .category-transaction-amount {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--accent-danger);
        }

        .category-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-stat-box {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-info);
        }

        .category-stat-label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .category-stat-value {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Firebase Auth UI */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-container {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 50px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .auth-logo {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .auth-title {
            font-family: 'Syne', sans-serif;
            font-size: 2em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            padding: 18px 30px;
            background: white;
            color: #333;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .google-signin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .google-icon {
            width: 24px;
            height: 24px;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--bg-card);
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: var(--text-secondary);
            z-index: 1000;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }

        .sync-indicator.syncing {
            background: var(--accent-warning);
            animation: pulse 0.5s infinite;
        }

        .sync-indicator.offline {
            background: var(--text-muted);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
        }

        .user-info {
            flex: 1;
            text-align: left;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .user-email {
            font-size: 0.75em;
            color: var(--text-muted);
        }

        .signout-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-danger);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .signout-btn:hover {
            background: var(--accent-danger);
            color: white;
        }

        .auth-features {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: left;
        }

        .auth-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .auth-feature-icon {
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="bg-gradient"></div>
        <div class="bg-gradient"></div>
        <div class="bg-gradient"></div>
    </div>

    <!-- Firebase Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-container">
            <div class="auth-logo"></div>
            <h1 class="auth-title">Welcome to FinanceFlow</h1>
            <p class="auth-subtitle" id="authSubtitle">
                Sign in with Google to sync your financial data across all your devices securely.
            </p>
            
            <button class="google-signin-btn" id="googleSignInBtn" onclick="signInWithGoogle()">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Sign in with Google</span>
            </button>

            <p style="margin-top: 15px; font-size: 0.85em; color: var(--text-muted);">
                Having issues? <a href="#" onclick="signInWithRedirect(); return false;" style="color: var(--accent-primary); text-decoration: underline;">Try redirect method</a>
            </p>

            <button class="btn-secondary" id="skipAuthBtn" onclick="skipAuth()" style="width: 100%; margin-top: 15px; display: none;">
                Skip for now (Local storage only)
            </button>

            <div class="auth-features">
                <div class="auth-feature">
                    <span class="auth-feature-icon"></span>
                    <span>Automatic cloud sync across all devices</span>
                </div>
                <div class="auth-feature">
                    <span class="auth-feature-icon"></span>
                    <span>Secure and encrypted data storage</span>
                </div>
                <div class="auth-feature">
                    <span class="auth-feature-icon"></span>
                    <span>Access from phone, tablet, or computer</span>
                </div>
                <div class="auth-feature">
                    <span class="auth-feature-icon"></span>
                    <span>Never lose your financial data</span>
                </div>
            </div>

            <div id="firebaseNotConfigured" style="display: none; margin-top: 30px; padding: 20px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px;">
                <p style="font-size: 0.9em; color: var(--accent-warning); font-weight: 600; margin-bottom: 10px;">
                     Cloud Sync Not Configured Yet
                </p>
                <p style="font-size: 0.85em; color: var(--text-secondary); line-height: 1.6;">
                    To enable cloud sync, follow the setup guide (SETUP_GUIDE.md). For now, you can use the app with local storage only.
                </p>
            </div>

            <p style="margin-top: 30px; font-size: 0.85em; color: var(--text-muted);">
                Your data is encrypted and only accessible by you
            </p>
        </div>
    </div>

    <!-- Sync Status Indicator -->
    <div id="syncStatus" class="sync-status" style="display: none;">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncText">Synced</span>
    </div>

    <div class="container">
        <header>
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                <h1 class="logo"> FinanceFlow</h1>
            </div>
            <div id="userNameDisplay" style="font-size: 1.1em; color: var(--text-secondary); margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;" onclick="editUserName()">
                <span id="userName">Click to set your name</span>
                <span style="font-size: 0.8em; opacity: 0.7;"></span>
            </div>
            <p class="tagline">Your Smart Money Management Dashboard</p>
            <div class="header-actions">
                <div id="userProfile" style="display: none;"></div>
                <button class="btn-secondary" onclick="exportData()">
                    <span></span> Export Data
                </button>
                <button class="btn-secondary" onclick="openImportModal()">
                    <span></span> Import Data
                </button>
                <button class="btn-secondary" onclick="openClearModal()">
                    <span></span> Clear All Data
                </button>
            </div>
        </header>

        <!-- Dashboard Stats -->
        <div class="dashboard">
            <div class="stat-card income">
                <div class="stat-icon"></div>
                <div class="stat-label">Total Income</div>
                <div class="stat-value" id="totalIncome">$0.00</div>
                <div class="stat-change">This month</div>
            </div>
            <div class="stat-card expenses">
                <div class="stat-icon"></div>
                <div class="stat-label">Total Expenses</div>
                <div class="stat-value" id="totalExpenses">$0.00</div>
                <div class="stat-change">This month</div>
            </div>
            <div class="stat-card balance">
                <div class="stat-icon"></div>
                <div class="stat-label">Balance</div>
                <div class="stat-value" id="balance">$0.00</div>
                <div class="stat-change">Available</div>
            </div>
            <div class="stat-card savings">
                <div class="stat-icon"></div>
                <div class="stat-label">Savings Rate</div>
                <div class="stat-value" id="savingsRate">0%</div>
                <div class="stat-change">Of income</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-grid">
            <!-- Add Transaction -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon"></span>
                        Add Transaction
                    </h2>
                </div>
                <form id="transactionForm" class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select id="type" class="form-select" required>
                            <option value="">Select Type</option>
                            <option value="income"> Income</option>
                            <option value="expense"> Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" id="name" class="form-input" placeholder="e.g., Monthly Salary, Groceries" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" id="amount" class="form-input" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="category" class="form-select" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Attachments (Optional)</label>
                        <div class="attachment-input-area" id="attachmentArea" onclick="document.getElementById('attachmentInput').click()">
                            <div class="attachment-icon"></div>
                            <div class="attachment-text">Click to attach photos or documents</div>
                            <div class="attachment-text" style="font-size: 0.8em; color: var(--text-muted); margin-top: 5px;">
                                Supports: Images (JPG, PNG, GIF), PDFs, Documents
                            </div>
                        </div>
                        <input type="file" id="attachmentInput" multiple accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;">
                        <div class="attachment-preview" id="attachmentPreview"></div>
                    </div>
                    <button type="submit" class="btn btn-full">Add Transaction</button>
                </form>
            </div>

            <!-- Recent Transactions -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon"></span>
                        Recent Transactions
                    </h2>
                </div>

                <!-- Search and Filter Bar -->
                <div class="search-filter-bar">
                    <!-- Search Box -->
                    <div class="search-box">
                        <span class="search-icon"></span>
                        <input type="text" id="searchInput" class="search-input" placeholder="Search by name, amount, or category...">
                        <button class="clear-search" id="clearSearch" onclick="clearSearch()"></button>
                    </div>

                    <!-- Advanced Filters -->
                    <div class="advanced-filters">
                        <select id="filterCategory" class="filter-select">
                            <option value="">All Categories</option>
                        </select>
                        <select id="filterMonth" class="filter-select">
                            <option value="">All Months</option>
                        </select>
                        <select id="filterYear" class="filter-select">
                            <option value="">All Years</option>
                        </select>
                        <select id="filterAmount" class="filter-select">
                            <option value="">Any Amount</option>
                            <option value="0-50">$0 - $50</option>
                            <option value="50-100">$50 - $100</option>
                            <option value="100-500">$100 - $500</option>
                            <option value="500-1000">$500 - $1,000</option>
                            <option value="1000+">$1,000+</option>
                        </select>
                    </div>

                    <!-- Active Filters Display -->
                    <div class="active-filters" id="activeFilters"></div>

                    <!-- Results Count and Clear All -->
                    <div class="results-count" id="resultsCount"></div>

                    <!-- Sort Options -->
                    <div class="sort-options">
                        <button class="sort-btn active" data-sort="date-desc" onclick="setSortOption('date-desc')">
                             Newest First
                        </button>
                        <button class="sort-btn" data-sort="date-asc" onclick="setSortOption('date-asc')">
                             Oldest First
                        </button>
                        <button class="sort-btn" data-sort="amount-desc" onclick="setSortOption('amount-desc')">
                             Highest Amount
                        </button>
                        <button class="sort-btn" data-sort="amount-asc" onclick="setSortOption('amount-asc')">
                             Lowest Amount
                        </button>
                    </div>
                </div>

                <div class="filter-tabs">
                    <div class="filter-tab active" data-filter="all">All</div>
                    <div class="filter-tab" data-filter="income">Income</div>
                    <div class="filter-tab" data-filter="expense">Expenses</div>
                </div>
                <div class="transaction-list" id="transactionList">
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p class="empty-text">No transactions yet. Start tracking your finances!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon"></span>
                        Expenses by Category
                    </h2>
                </div>
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon"></span>
                        Income vs Expenses
                    </h2>
                </div>
                <div class="chart-wrapper">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon"></span>
                        Monthly Trend
                    </h2>
                </div>
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon"></span>
                        Income Sources
                    </h2>
                </div>
                <div class="chart-wrapper">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Category Details View -->
        <div class="section-card category-detail-section" style="margin-top: 25px; animation: fadeInUp 0.8s ease-out 0.85s both;">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon"></span>
                    Category Deep Dive
                </h2>
            </div>

            <!-- Category Selector -->
            <div class="form-group">
                <label class="form-label">Select Category to Analyze</label>
                <select id="categoryDetailSelect" class="form-select" onchange="updateCategoryDetail()">
                    <option value="">Choose a category...</option>
                </select>
            </div>

            <!-- Month Selector -->
            <div id="monthSelectorContainer" style="display: none;">
                <label class="form-label" style="margin-bottom: 15px; display: block;">Select Month</label>
                <div class="month-selector-grid" id="monthSelector"></div>
            </div>

            <!-- Category Details -->
            <div id="categoryDetailContent"></div>
        </div>

        <!-- AI Financial Insights -->
        <div class="section-card" style="margin-top: 25px; animation: fadeInUp 0.8s ease-out 0.9s both;">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon"></span>
                    AI Financial Advisor
                </h2>
                <button class="ai-insights-btn" id="aiInsightsBtn" onclick="generateAIInsights()">
                    <span></span>
                    <span>Get AI Analysis</span>
                </button>
            </div>
            
            <div class="ai-insights-panel" id="aiInsightsPanel"></div>

            <div class="privacy-notice">
                <strong> Privacy & Security:</strong> This feature can analyze your financial data using Claude AI (by Anthropic) to provide personalized insights. The analysis happens securely in your browser, and your data is never stored on external servers. 
                <br><br>
                <strong>Note:</strong> Currently shows manual analysis based on your spending patterns. For full AI-powered insights with Claude, API access would be needed.
            </div>
        </div>

        <!-- Budget Overview -->
        <div class="section-card" style="margin-top: 25px; animation: fadeInUp 0.8s ease-out 1s both;">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon"></span>
                    Budget Management
                </h2>
            </div>

            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('spending')"> Spending Overview</button>
                <button class="tab-btn" onclick="switchTab('budgets')"> Set Budgets</button>
                <button class="tab-btn" onclick="switchTab('comparison')"> Month Comparison</button>
            </div>

            <div id="spendingTab" class="tab-content active">
                <div id="budgetOverview"></div>
            </div>

            <div id="budgetsTab" class="tab-content">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Set monthly budget limits for each expense category to track your spending goals.</p>
                <div id="budgetList"></div>
            </div>

            <div id="comparisonTab" class="tab-content">
                <div id="monthComparison"></div>
            </div>
        </div>

        <!-- Alerts Container -->
        <div class="alert-container" id="alertContainer"></div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Import Data</h3>
                <button class="close-modal" onclick="closeImportModal()"></button>
            </div>
            <div class="modal-body">
                <p class="modal-text">Upload a previously exported JSON file to restore your financial data.</p>
                <div class="warning-message">
                    <span></span>
                    <span>This will replace your current data. Make sure to export your current data first if you want to keep it!</span>
                </div>
                <div class="file-upload-area" id="dropZone">
                    <div class="upload-icon"></div>
                    <div class="upload-text">Drag & drop your file here</div>
                    <div class="upload-hint">or click to browse</div>
                    <input type="file" id="fileInput" accept=".json" style="display: none;">
                </div>
                <div class="success-message" id="importSuccess">
                    <span></span>
                    <span>Data imported successfully!</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear Data Modal -->
    <div id="clearModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Clear All Data</h3>
                <button class="close-modal" onclick="closeClearModal()"></button>
            </div>
            <div class="modal-body">
                <div class="warning-message">
                    <span></span>
                    <span><strong>Warning:</strong> This action cannot be undone! All your transactions and financial data will be permanently deleted. Consider exporting your data first.</span>
                </div>
                <p class="modal-text">Are you absolutely sure you want to delete all your data?</p>
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="btn-secondary" onclick="closeClearModal()" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn" onclick="clearAllData()" style="flex: 1; background: linear-gradient(135deg, #ef4444, #dc2626);">
                    Delete Everything
                </button>
            </div>
        </div>
    </div>

    <!-- Set Budget Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Set Budget</h3>
                <button class="close-modal" onclick="closeBudgetModal()"></button>
            </div>
            <div class="modal-body">
                <form id="budgetForm">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="budgetCategory" class="form-select" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monthly Budget Limit</label>
                        <input type="number" id="budgetAmount" class="form-input" placeholder="0.00" step="0.01" required>
                    </div>
                    <button type="submit" class="btn btn-full">Set Budget</button>
                </form>
            </div>
        </div>
    </div>

    <!-- User Name Modal -->
    <div id="userNameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Set Your Name</h3>
                <button class="close-modal" onclick="closeUserNameModal()"></button>
            </div>
            <div class="modal-body">
                <form id="userNameForm">
                    <div class="form-group">
                        <label class="form-label">Your Name</label>
                        <input type="text" id="userNameInput" class="form-input" placeholder="Enter your name" required>
                    </div>
                    <button type="submit" class="btn btn-full">Save Name</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="viewerModal" class="viewer-modal">
        <div class="viewer-content">
            <div class="viewer-header">
                <div class="viewer-title" id="viewerTitle">Document Viewer</div>
                <button class="viewer-close" onclick="closeViewer()"></button>
            </div>
            <div class="viewer-body" id="viewerBody"></div>
            <div class="viewer-navigation">
                <button class="viewer-nav-btn" id="prevBtn" onclick="navigateAttachment(-1)"> Previous</button>
                <span id="attachmentCounter" style="color: var(--text-secondary); display: flex; align-items: center;"></span>
                <button class="viewer-nav-btn" id="nextBtn" onclick="navigateAttachment(1)">Next </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // TODO: Replace with your Firebase config after setup
        // Get this from Firebase Console (instructions below)
        const firebaseConfig = {
            apiKey: "AIzaSyDGSsu840Gj9GjAqEOgUBpx9N9AvEI9dNo",
            authDomain: "financeflow-sync.firebaseapp.com",
            databaseURL: "https://financeflow-sync-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "financeflow-sync",
            storageBucket: "financeflow-sync.firebasestorage.app",
            messagingSenderId: "947359542968",
            appId: "1:947359542968:web:927a7f45c37de3eac60e4d"
        };

        // ============================================
        // ACCOUNT WHITELIST - Only these emails can sign in
        // ============================================
        // TODO: Replace with your Google account email(s)
        // Add your email here to restrict access
        const ALLOWED_EMAILS = [
            "m.ahmadi.ouassim@gmail.com"  // Replace with your actual email
        ];

        // Set to true to enable email whitelist (blocks other accounts)
        // Set to false to allow anyone (Firebase rules still protect data)
        const ENABLE_EMAIL_WHITELIST = true;

        // Function to check if email is allowed
        function isEmailAllowed(email) {
            if (!ENABLE_EMAIL_WHITELIST) return true;
            return ALLOWED_EMAILS.some(allowed => allowed.toLowerCase() === email.toLowerCase());
        }

        // Initialize Firebase
        let firebaseInitialized = false;
        let currentUser = null;
        let database = null;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseInitialized = true;
                console.log(" Firebase initialized successfully");
            } else {
                console.log(" Firebase not configured. Using local storage only.");
                // Show skip button and warning
                document.getElementById('skipAuthBtn').style.display = 'block';
                document.getElementById('firebaseNotConfigured').style.display = 'block';
                document.getElementById('googleSignInBtn').disabled = true;
                document.getElementById('googleSignInBtn').style.opacity = '0.5';
                document.getElementById('googleSignInBtn').style.cursor = 'not-allowed';
            }
        } catch (error) {
            console.error("Firebase initialization error:", error);
            document.getElementById('skipAuthBtn').style.display = 'block';
            document.getElementById('firebaseNotConfigured').style.display = 'block';
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        
        function signInWithGoogle() {
            if (!firebaseInitialized) {
                showNotification(' Firebase not configured. Click "Skip for now" to use local storage.', 'error');
                return;
            }

            console.log(" Attempting Google sign in...");
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Add additional scopes if needed
            provider.addScope('email');
            provider.addScope('profile');
            
            firebase.auth().signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    const userEmail = user.email.toLowerCase();
                    
                    // Check if email is allowed
                    if (!isEmailAllowed(userEmail)) {
                        console.log(" Unauthorized email:", userEmail);
                        
                        // Sign out unauthorized user
                        firebase.auth().signOut();
                        
                        // Show error message
                        showNotification(' Access Denied! Only authorized accounts can sign in.', 'error');
                        
                        // Show detailed message
                        alert(` ACCESS DENIED\n\nThis app is restricted to authorized users only.\n\nYour email: ${userEmail}\n\nIf you believe this is an error, contact the app owner.`);
                        
                        return;
                    }
                    
                    // Email is allowed - proceed
                    currentUser = user;
                    console.log(" Sign in successful:", currentUser.displayName);
                    showNotification(` Welcome, ${currentUser.displayName}!`, 'success');
                    document.getElementById('authOverlay').classList.add('hidden');
                    loadDataFromFirebase();
                })
                .catch((error) => {
                    console.error("Sign in error:", error);
                    
                    // Handle specific error cases
                    if (error.code === 'auth/popup-blocked') {
                        showNotification(' Popup blocked! Please allow popups for this site and try again.', 'error');
                        alert('Popup was blocked by your browser. Please:\n1. Allow popups for this site\n2. Try signing in again');
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        showNotification(' Sign in cancelled', 'error');
                    } else if (error.code === 'auth/unauthorized-domain') {
                        showNotification(' This domain is not authorized. Add it in Firebase Console > Authentication > Settings > Authorized domains', 'error');
                        console.error("Add your domain to Firebase authorized domains!");
                    } else {
                        showNotification(` Sign in failed: ${error.message}`, 'error');
                    }
                });
        }

        function skipAuth() {
            console.log(" Using local storage mode");
            document.getElementById('authOverlay').classList.add('hidden');
            
            // Load from localStorage
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            budgets = JSON.parse(localStorage.getItem('budgets')) || {};
            userName = localStorage.getItem('userName') || '';
            
            updateUI();
            updateUserNameDisplay();
            
            showNotification(' Using local storage mode. Data saved on this device only.', 'success');
        }

        function signInWithRedirect() {
            if (!firebaseInitialized) {
                showNotification(' Firebase not configured.', 'error');
                return;
            }

            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithRedirect(provider);
        }

        // Handle redirect result
        if (firebaseInitialized) {
            firebase.auth().getRedirectResult()
                .then((result) => {
                    if (result.user) {
                        currentUser = result.user;
                        console.log(" Sign in successful via redirect:", currentUser.displayName);
                        showNotification(` Welcome, ${currentUser.displayName}!`, 'success');
                    }
                })
                .catch((error) => {
                    console.error("Redirect sign in error:", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        alert(' IMPORTANT: You need to authorize this domain in Firebase!\n\n1. Go to Firebase Console\n2. Authentication  Settings\n3. Authorized domains\n4. Add: ' + window.location.hostname + '\n\nThen try again.');
                    }
                });
        }

        function signOut() {
            if (!firebaseInitialized) return;
            
            firebase.auth().signOut().then(() => {
                currentUser = null;
                document.getElementById('authOverlay').classList.remove('hidden');
                document.getElementById('syncStatus').style.display = 'none';
                showNotification(' Signed out successfully', 'success');
            });
        }

        // Monitor auth state
        if (firebaseInitialized) {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // Check if email is allowed
                    if (!isEmailAllowed(user.email)) {
                        console.log(" Unauthorized email detected:", user.email);
                        
                        // Sign out unauthorized user immediately
                        firebase.auth().signOut();
                        
                        // Show error
                        showNotification(' Access Denied! Unauthorized account.', 'error');
                        alert(` ACCESS DENIED\n\nThis app is restricted to authorized users only.\n\nYour email: ${user.email}\n\nPlease contact the app owner if you believe this is an error.`);
                        
                        return;
                    }
                    
                    // User is authorized
                    currentUser = user;
                    document.getElementById('authOverlay').classList.add('hidden');
                    document.getElementById('syncStatus').style.display = 'flex';
                    updateUserProfile();
                    loadDataFromFirebase();
                    setupRealtimeSync();
                } else {
                    currentUser = null;
                    document.getElementById('authOverlay').classList.remove('hidden');
                    document.getElementById('syncStatus').style.display = 'none';
                }
            });
        }
        // If Firebase not initialized, user must click "Skip for now"

        function updateUserProfile() {
            if (!currentUser) return;
            
            const profileHTML = `
                <div class="user-profile">
                    <img src="${currentUser.photoURL}" alt="${currentUser.displayName}" class="user-avatar">
                    <div class="user-info">
                        <div class="user-name">${currentUser.displayName}</div>
                        <div class="user-email">${currentUser.email}</div>
                    </div>
                    <button class="budget-edit-btn" onclick="showMyUserID()" style="margin-right: 10px;">
                        Show My ID
                    </button>
                    <button class="signout-btn" onclick="signOut()">Sign Out</button>
                </div>
            `;
            document.getElementById('userProfile').innerHTML = profileHTML;
            document.getElementById('userProfile').style.display = 'block';
        }

        // Show User ID function
        function showMyUserID() {
            if (!currentUser) {
                alert(' No user signed in');
                return;
            }

            const userID = currentUser.uid;
            const userEmail = currentUser.email;
            
            // Create a modal with the ID
            const message = `
 YOUR FIREBASE USER ID:

${userID}

 Email: ${userEmail}



 COPY THIS ID:
Use this ID in Firebase Security Rules to restrict access to only your account.

 HOW TO USE:
1. Copy the ID above (long press to select)
2. Go to Firebase Console
3. Realtime Database  Rules
4. Replace YOUR_USER_ID with this ID
5. Publish rules



Tap OK to copy to clipboard
            `.trim();

            alert(message);

            // Try to copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(userID)
                    .then(() => {
                        showNotification(' User ID copied to clipboard!', 'success');
                    })
                    .catch(() => {
                        showNotification(' Please copy the ID manually from the alert', 'error');
                    });
            } else {
                // Fallback for browsers that don't support clipboard API
                showNotification(' User ID shown above - please copy manually', 'success');
            }
        }

        // ============================================
        // FIREBASE SYNC FUNCTIONS
        // ============================================

        function setSyncStatus(status) {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncText');
            
            if (status === 'synced') {
                indicator.className = 'sync-indicator';
                text.textContent = 'Synced ';
            } else if (status === 'syncing') {
                indicator.className = 'sync-indicator syncing';
                text.textContent = 'Syncing...';
            } else if (status === 'offline') {
                indicator.className = 'sync-indicator offline';
                text.textContent = 'Offline';
            }
        }

        function saveToFirebase() {
            if (!firebaseInitialized || !currentUser) {
                // Fallback to localStorage
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('budgets', JSON.stringify(budgets));
                return;
            }

            setSyncStatus('syncing');
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.set({
                transactions: transactions,
                budgets: budgets,
                userName: userName,
                lastUpdated: Date.now()
            }).then(() => {
                setSyncStatus('synced');
                console.log(' Data synced to cloud');
            }).catch((error) => {
                console.error('Sync error:', error);
                setSyncStatus('offline');
                // Fallback to localStorage
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('budgets', JSON.stringify(budgets));
            });
        }

        function loadDataFromFirebase() {
            if (!firebaseInitialized || !currentUser) {
                // Load from localStorage
                transactions = JSON.parse(localStorage.getItem('transactions')) || [];
                budgets = JSON.parse(localStorage.getItem('budgets')) || {};
                userName = localStorage.getItem('userName') || '';
                updateUI();
                return;
            }

            setSyncStatus('syncing');
            
            const userRef = database.ref('users/' + currentUser.uid);
            userRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    transactions = data.transactions || [];
                    budgets = data.budgets || {};
                    userName = data.userName || currentUser.displayName || '';
                    
                    // Save to localStorage as backup
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    localStorage.setItem('budgets', JSON.stringify(budgets));
                    localStorage.setItem('userName', userName);
                    
                    updateUI();
                    setSyncStatus('synced');
                    console.log(' Data loaded from cloud');
                } else {
                    // First time user - use localStorage if available
                    const localTransactions = JSON.parse(localStorage.getItem('transactions'));
                    if (localTransactions && localTransactions.length > 0) {
                        // Migrate local data to cloud
                        saveToFirebase();
                        showNotification(' Local data migrated to cloud!', 'success');
                    }
                    setSyncStatus('synced');
                }
            }).catch((error) => {
                console.error('Load error:', error);
                setSyncStatus('offline');
                // Fallback to localStorage
                transactions = JSON.parse(localStorage.getItem('transactions')) || [];
                budgets = JSON.parse(localStorage.getItem('budgets')) || {};
                updateUI();
            });
        }

        function setupRealtimeSync() {
            if (!firebaseInitialized || !currentUser) return;

            const userRef = database.ref('users/' + currentUser.uid);
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.lastUpdated) {
                    const localLastUpdate = parseInt(localStorage.getItem('lastLocalUpdate') || '0');
                    
                    // Only update if cloud data is newer
                    if (data.lastUpdated > localLastUpdate) {
                        transactions = data.transactions || [];
                        budgets = data.budgets || {};
                        userName = data.userName || '';
                        
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        localStorage.setItem('budgets', JSON.stringify(budgets));
                        localStorage.setItem('userName', userName);
                        
                        updateUI();
                        console.log(' Data updated from another device');
                    }
                }
            });
        }

        // ============================================
        // DATA STORAGE (Updated for Firebase)
        // ============================================
        // Comprehensive Categories
        const categories = {
            income: [
                ' Salary & Wages',
                ' Business Income',
                ' Investment Returns',
                ' Rental Income',
                ' Gifts & Bonuses',
                ' Cashback & Rewards',
                ' Freelance & Side Gigs',
                ' Scholarships & Grants',
                ' Commission',
                ' Tax Refund',
                ' Other Income'
            ],
            expense: [
                // Essential
                ' Housing & Rent',
                ' Utilities & Bills',
                ' Food & Groceries',
                ' Transportation',
                ' Fuel & Gas',
                ' Healthcare & Medical',
                ' Pharmacy & Medications',
                
                // Lifestyle
                ' Clothing & Fashion',
                ' Beauty & Personal Care',
                ' Entertainment',
                ' Streaming Services',
                ' Gaming & Hobbies',
                ' Phone & Internet',
                ' Software & Subscriptions',
                ' Music & Concerts',
                ' Books & Magazines',
                
                // Financial
                ' Credit Card Payments',
                ' Loan Payments',
                ' Insurance',
                ' Savings & Investments',
                ' Taxes',
                ' Gifts & Donations',
                
                // Education & Development
                ' Education & Courses',
                ' Training & Development',
                
                // Travel & Leisure
                ' Travel & Vacation',
                ' Hotels & Accommodation',
                ' Dining & Restaurants',
                ' Coffee & Snacks',
                
                // Family & Pets
                ' Childcare & Kids',
                ' Pet Care',
                
                // Home & Maintenance
                ' Home Maintenance',
                ' Furniture & Appliances',
                ' Garden & Outdoor',
                
                // Health & Fitness
                ' Gym & Fitness',
                ' Wellness & Spa',
                
                // Other
                ' Emergency Expenses',
                ' Other Expenses'
            ]
        };

        // Data storage
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let budgets = JSON.parse(localStorage.getItem('budgets')) || {};
        let userName = localStorage.getItem('userName') || '';
        let currentFilter = 'all';
        let charts = {};
        let alerts = [];
        let dismissedAlerts = JSON.parse(localStorage.getItem('dismissedAlerts')) || {};
        
        // Search and filter state
        let searchQuery = '';
        let filterCategory = '';
        let filterMonth = '';
        let filterYear = '';
        let filterAmount = '';
        let sortOption = 'date-desc';
        
        // Category detail state
        let selectedCategory = '';
        let selectedMonth = new Date().getMonth();
        let selectedYear = new Date().getFullYear();

        // DOM elements
        const transactionForm = document.getElementById('transactionForm');
        const typeSelect = document.getElementById('type');
        const categorySelect = document.getElementById('category');
        const dateInput = document.getElementById('date');
        const transactionList = document.getElementById('transactionList');
        const attachmentInput = document.getElementById('attachmentInput');
        const attachmentArea = document.getElementById('attachmentArea');
        const attachmentPreview = document.getElementById('attachmentPreview');

        // File handling
        let currentAttachments = [];
        let viewerAttachments = [];
        let currentViewerIndex = 0;

        // Set today's date
        dateInput.valueAsDate = new Date();

        // Handle file attachments
        attachmentInput.addEventListener('change', function(e) {
            handleAttachmentSelect(e.target.files);
        });

        // Drag and drop support
        attachmentArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            attachmentArea.style.borderColor = 'var(--accent-primary)';
        });

        attachmentArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            attachmentArea.style.borderColor = '';
        });

        attachmentArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            attachmentArea.style.borderColor = '';
            handleAttachmentSelect(e.dataTransfer.files);
        });

        function handleAttachmentSelect(files) {
            Array.from(files).forEach(file => {
                // Check file size (max 5MB per file)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(' File too large! Max 5MB per file.', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    currentAttachments.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                        size: file.size
                    });
                    updateAttachmentPreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateAttachmentPreview() {
            if (currentAttachments.length === 0) {
                attachmentPreview.innerHTML = '';
                attachmentArea.classList.remove('has-files');
                return;
            }

            attachmentArea.classList.add('has-files');
            attachmentPreview.innerHTML = currentAttachments.map((file, index) => {
                const isImage = file.type.startsWith('image/');
                if (isImage) {
                    return `
                        <div class="attachment-item">
                            <img src="${file.data}" alt="${file.name}">
                            <button class="remove-attachment" onclick="removeAttachment(${index})"></button>
                        </div>
                    `;
                } else {
                    const icon = file.type.includes('pdf') ? '' : '';
                    return `
                        <div class="attachment-item">
                            <div class="attachment-item-doc">
                                <div class="attachment-item-icon">${icon}</div>
                                <div class="attachment-item-name">${file.name}</div>
                            </div>
                            <button class="remove-attachment" onclick="removeAttachment(${index})"></button>
                        </div>
                    `;
                }
            }).join('');
        }

        function removeAttachment(index) {
            currentAttachments.splice(index, 1);
            updateAttachmentPreview();
        }

        // Document Viewer Functions
        function openViewer(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction || !transaction.attachments || transaction.attachments.length === 0) {
                return;
            }

            viewerAttachments = transaction.attachments;
            currentViewerIndex = 0;
            displayAttachment();
            document.getElementById('viewerModal').classList.add('active');
        }

        function closeViewer() {
            document.getElementById('viewerModal').classList.remove('active');
            viewerAttachments = [];
            currentViewerIndex = 0;
        }

        function navigateAttachment(direction) {
            currentViewerIndex += direction;
            displayAttachment();
        }

        function displayAttachment() {
            const attachment = viewerAttachments[currentViewerIndex];
            const viewerBody = document.getElementById('viewerBody');
            const viewerTitle = document.getElementById('viewerTitle');
            const counter = document.getElementById('attachmentCounter');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            viewerTitle.textContent = attachment.name;
            counter.textContent = `${currentViewerIndex + 1} / ${viewerAttachments.length}`;

            prevBtn.disabled = currentViewerIndex === 0;
            nextBtn.disabled = currentViewerIndex === viewerAttachments.length - 1;

            if (attachment.type.startsWith('image/')) {
                viewerBody.innerHTML = `<img src="${attachment.data}" class="viewer-image" alt="${attachment.name}">`;
            } else if (attachment.type.includes('pdf')) {
                viewerBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4em; margin-bottom: 20px;"></div>
                        <div style="color: var(--text-primary); font-size: 1.2em; margin-bottom: 15px;">${attachment.name}</div>
                        <a href="${attachment.data}" download="${attachment.name}" class="btn" style="display: inline-block; text-decoration: none;">
                            Download PDF
                        </a>
                    </div>
                `;
            } else {
                viewerBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4em; margin-bottom: 20px;"></div>
                        <div style="color: var(--text-primary); font-size: 1.2em; margin-bottom: 15px;">${attachment.name}</div>
                        <a href="${attachment.data}" download="${attachment.name}" class="btn" style="display: inline-block; text-decoration: none;">
                            Download File
                        </a>
                    </div>
                `;
            }
        }

        // Search and Filter Setup
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearch');
        const filterCategorySelect = document.getElementById('filterCategory');
        const filterMonthSelect = document.getElementById('filterMonth');
        const filterYearSelect = document.getElementById('filterYear');
        const filterAmountSelect = document.getElementById('filterAmount');

        // Search input handler
        searchInput.addEventListener('input', function(e) {
            searchQuery = e.target.value.toLowerCase();
            clearSearchBtn.classList.toggle('visible', searchQuery !== '');
            updateTransactionList();
        });

        // Clear search
        function clearSearch() {
            searchInput.value = '';
            searchQuery = '';
            clearSearchBtn.classList.remove('visible');
            updateTransactionList();
        }

        // Filter change handlers
        filterCategorySelect.addEventListener('change', function() {
            filterCategory = this.value;
            updateTransactionList();
        });

        filterMonthSelect.addEventListener('change', function() {
            filterMonth = this.value;
            updateTransactionList();
        });

        filterYearSelect.addEventListener('change', function() {
            filterYear = this.value;
            updateTransactionList();
        });

        filterAmountSelect.addEventListener('change', function() {
            filterAmount = this.value;
            updateTransactionList();
        });

        // Sort option handler
        function setSortOption(option) {
            sortOption = option;
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-sort="${option}"]`).classList.add('active');
            updateTransactionList();
        }

        // Populate filter dropdowns
        function populateFilterDropdowns() {
            // Categories
            const allCategories = new Set();
            transactions.forEach(t => allCategories.add(t.category));
            
            filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
            Array.from(allCategories).sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filterCategorySelect.appendChild(option);
            });

            // Months and Years
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const years = new Set();
            
            transactions.forEach(t => {
                years.add(new Date(t.date).getFullYear());
            });

            filterMonthSelect.innerHTML = '<option value="">All Months</option>';
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                filterMonthSelect.appendChild(option);
            });

            filterYearSelect.innerHTML = '<option value="">All Years</option>';
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                filterYearSelect.appendChild(option);
            });
        }

        // Update active filters display
        function updateActiveFilters() {
            const activeFiltersDiv = document.getElementById('activeFilters');
            const filters = [];

            if (searchQuery) {
                filters.push({ label: `Search: "${searchQuery}"`, clear: () => clearSearch() });
            }
            if (filterCategory) {
                filters.push({ label: `Category: ${filterCategory}`, clear: () => {
                    filterCategorySelect.value = '';
                    filterCategory = '';
                    updateTransactionList();
                }});
            }
            if (filterMonth !== '') {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                filters.push({ label: `Month: ${months[filterMonth]}`, clear: () => {
                    filterMonthSelect.value = '';
                    filterMonth = '';
                    updateTransactionList();
                }});
            }
            if (filterYear) {
                filters.push({ label: `Year: ${filterYear}`, clear: () => {
                    filterYearSelect.value = '';
                    filterYear = '';
                    updateTransactionList();
                }});
            }
            if (filterAmount) {
                filters.push({ label: `Amount: $${filterAmount}`, clear: () => {
                    filterAmountSelect.value = '';
                    filterAmount = '';
                    updateTransactionList();
                }});
            }

            if (filters.length === 0) {
                activeFiltersDiv.innerHTML = '';
                return;
            }

            activeFiltersDiv.innerHTML = filters.map((filter, index) => `
                <div class="filter-chip">
                    <span>${filter.label}</span>
                    <button class="filter-chip-close" onclick="clearSpecificFilter(${index})"></button>
                </div>
            `).join('');

            // Store filter clear functions
            window.filterClearFunctions = filters.map(f => f.clear);
        }

        function clearSpecificFilter(index) {
            if (window.filterClearFunctions && window.filterClearFunctions[index]) {
                window.filterClearFunctions[index]();
            }
        }

        function clearAllFilters() {
            searchInput.value = '';
            searchQuery = '';
            filterCategorySelect.value = '';
            filterCategory = '';
            filterMonthSelect.value = '';
            filterMonth = '';
            filterYearSelect.value = '';
            filterYear = '';
            filterAmountSelect.value = '';
            filterAmount = '';
            clearSearchBtn.classList.remove('visible');
            updateTransactionList();
        }

        // Category icons mapping
        const categoryIcons = {
            'Salary & Wages': '',
            'Business Income': '',
            'Investment Returns': '',
            'Rental Income': '',
            'Gifts & Bonuses': '',
            'Housing & Rent': '',
            'Food & Groceries': '',
            'Transportation': '',
            'Entertainment': '',
            'Healthcare & Medical': '',
            'Shopping': '',
            'Utilities & Bills': ''
        };

        // Update categories based on type
        typeSelect.addEventListener('change', function() {
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            const selectedType = this.value;
            
            if (selectedType && categories[selectedType]) {
                categories[selectedType].forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categorySelect.appendChild(option);
                });
            }
        });

        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                updateTransactionList();
            });
        });

        // Handle form submission
        transactionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const transaction = {
                id: Date.now(),
                type: document.getElementById('type').value,
                name: document.getElementById('name').value,
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                attachments: [...currentAttachments] // Copy attachments
            };

            transactions.push(transaction);
            saveTransactions();
            updateUI();
            transactionForm.reset();
            dateInput.valueAsDate = new Date();
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            
            // Reset attachments
            currentAttachments = [];
            updateAttachmentPreview();
            
            // Animation for new transaction
            setTimeout(() => {
                const items = document.querySelectorAll('.transaction-item');
                if (items.length > 0) {
                    items[0].style.animation = 'slideInRight 0.5s ease-out';
                }
            }, 100);
        });

        // Save to localStorage
        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('lastLocalUpdate', Date.now().toString());
            saveToFirebase(); // Also save to cloud
        }

        function saveBudgets() {
            localStorage.setItem('budgets', JSON.stringify(budgets));
            localStorage.setItem('lastLocalUpdate', Date.now().toString());
            saveToFirebase(); // Also save to cloud
        }

        // Delete transaction
        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveTransactions();
            updateUI();
        }

        // Calculate totals
        function calculateTotals() {
            const income = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = income - expenses;
            const savingsRate = income > 0 ? ((balance / income) * 100) : 0;

            return { income, expenses, balance, savingsRate };
        }

        // Update dashboard
        function updateDashboard() {
            const { income, expenses, balance, savingsRate } = calculateTotals();

            document.getElementById('totalIncome').textContent = '$' + income.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalExpenses').textContent = '$' + expenses.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('balance').textContent = '$' + balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('savingsRate').textContent = savingsRate.toFixed(1) + '%';
        }

        // Update transaction list
        function updateTransactionList() {
            let filteredTransactions = transactions;

            // Apply type filter (All/Income/Expense)
            if (currentFilter !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.type === currentFilter);
            }

            // Apply search query
            if (searchQuery) {
                filteredTransactions = filteredTransactions.filter(t => {
                    return t.name.toLowerCase().includes(searchQuery) ||
                           t.category.toLowerCase().includes(searchQuery) ||
                           t.amount.toString().includes(searchQuery);
                });
            }

            // Apply category filter
            if (filterCategory) {
                filteredTransactions = filteredTransactions.filter(t => t.category === filterCategory);
            }

            // Apply month filter
            if (filterMonth !== '') {
                filteredTransactions = filteredTransactions.filter(t => {
                    return new Date(t.date).getMonth() === parseInt(filterMonth);
                });
            }

            // Apply year filter
            if (filterYear) {
                filteredTransactions = filteredTransactions.filter(t => {
                    return new Date(t.date).getFullYear() === parseInt(filterYear);
                });
            }

            // Apply amount filter
            if (filterAmount) {
                filteredTransactions = filteredTransactions.filter(t => {
                    const amount = t.amount;
                    if (filterAmount === '0-50') return amount >= 0 && amount <= 50;
                    if (filterAmount === '50-100') return amount > 50 && amount <= 100;
                    if (filterAmount === '100-500') return amount > 100 && amount <= 500;
                    if (filterAmount === '500-1000') return amount > 500 && amount <= 1000;
                    if (filterAmount === '1000+') return amount > 1000;
                    return true;
                });
            }

            // Apply sorting
            const sortedTransactions = [...filteredTransactions].sort((a, b) => {
                switch (sortOption) {
                    case 'date-desc':
                        // Sort by date descending, then by ID (timestamp) descending for same dates
                        const dateCompare = new Date(b.date) - new Date(a.date);
                        return dateCompare !== 0 ? dateCompare : b.id - a.id;
                    case 'date-asc':
                        // Sort by date ascending, then by ID (timestamp) ascending for same dates
                        const dateCompareAsc = new Date(a.date) - new Date(b.date);
                        return dateCompareAsc !== 0 ? dateCompareAsc : a.id - b.id;
                    case 'amount-desc':
                        // Sort by amount descending, then by ID descending for same amounts
                        const amountCompare = b.amount - a.amount;
                        return amountCompare !== 0 ? amountCompare : b.id - a.id;
                    case 'amount-asc':
                        // Sort by amount ascending, then by ID descending for same amounts
                        const amountCompareAsc = a.amount - b.amount;
                        return amountCompareAsc !== 0 ? amountCompareAsc : b.id - a.id;
                    default:
                        return new Date(b.date) - new Date(a.date);
                }
            });

            // Update active filters display
            updateActiveFilters();

            // Update results count
            const resultsCountDiv = document.getElementById('resultsCount');
            const totalCount = transactions.filter(t => currentFilter === 'all' || t.type === currentFilter).length;
            
            if (filteredTransactions.length === 0) {
                resultsCountDiv.innerHTML = `
                    <span>No transactions found</span>
                    ${searchQuery || filterCategory || filterMonth !== '' || filterYear || filterAmount ? 
                        '<button class="clear-all-filters" onclick="clearAllFilters()">Clear All Filters</button>' : ''}
                `;
            } else {
                resultsCountDiv.innerHTML = `
                    <span>Showing ${filteredTransactions.length} of ${totalCount} transactions</span>
                    ${searchQuery || filterCategory || filterMonth !== '' || filterYear || filterAmount ? 
                        '<button class="clear-all-filters" onclick="clearAllFilters()">Clear All Filters</button>' : ''}
                `;
            }

            // Display transactions
            if (filteredTransactions.length === 0) {
                transactionList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p class="empty-text">${searchQuery || filterCategory || filterMonth !== '' || filterYear || filterAmount ? 
                            'No transactions match your filters. Try adjusting your search criteria.' : 
                            (currentFilter === 'all' ? 'No transactions yet. Start tracking your finances!' : 'No ' + currentFilter + ' transactions found.')}</p>
                    </div>
                `;
                return;
            }

            transactionList.innerHTML = sortedTransactions.map(t => {
                const hasAttachments = t.attachments && t.attachments.length > 0;
                const attachmentHTML = hasAttachments ? `
                    <div class="transaction-attachments">
                        <div class="transaction-attachment-badge" onclick="openViewer(${t.id})">
                             ${t.attachments.length} file${t.attachments.length > 1 ? 's' : ''}
                        </div>
                    </div>
                ` : '';

                return `
                    <div class="transaction-item">
                        <div class="transaction-icon ${t.type}">
                            ${t.category.split(' ')[0]}
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-name">
                                ${t.name}
                                ${hasAttachments ? `<span class="attachment-count">${t.attachments.length}</span>` : ''}
                            </div>
                            <div class="transaction-category">
                                ${t.category}
                            </div>
                            <div class="transaction-date">${new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                            ${attachmentHTML}
                        </div>
                        <div class="transaction-amount ${t.type}">
                            ${t.type === 'income' ? '+' : '-'}$${t.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </div>
                        <button class="delete-btn" onclick="deleteTransaction(${t.id})">Delete</button>
                    </div>
                `;
            }).join('');

            // Update filter dropdowns
            populateFilterDropdowns();
        }

        // Update charts
        function updateCharts() {
            updateCategoryChart();
            updateComparisonChart();
            updateTrendChart();
            updateIncomeChart();
            updateBudgetOverview();
        }

        // Category Chart (Doughnut)
        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            const expensesByCategory = {};
            
            transactions.filter(t => t.type === 'expense').forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });

            if (Object.keys(expensesByCategory).length === 0) {
                if (charts.category) charts.category.destroy();
                return;
            }

            const data = {
                labels: Object.keys(expensesByCategory),
                datasets: [{
                    data: Object.values(expensesByCategory),
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c',
                        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                        '#fa709a', '#fee140', '#30cfd0', '#330867',
                        '#a8edea', '#fed6e3', '#ff9a9e', '#fecfef'
                    ],
                    borderWidth: 0
                }]
            };

            if (charts.category) {
                charts.category.destroy();
            }

            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#a5b4fc',
                                padding: 15,
                                font: {
                                    size: 11,
                                    family: 'Outfit'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a2149',
                            titleColor: '#ffffff',
                            bodyColor: '#a5b4fc',
                            borderColor: '#00d4ff',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.parsed.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Comparison Chart (Bar)
        function updateComparisonChart() {
            const ctx = document.getElementById('comparisonChart');
            const { income, expenses } = calculateTotals();

            if (income === 0 && expenses === 0) {
                if (charts.comparison) charts.comparison.destroy();
                return;
            }

            const data = {
                labels: ['Income', 'Expenses'],
                datasets: [{
                    data: [income, expenses],
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderColor: [
                        '#10b981',
                        '#ef4444'
                    ],
                    borderWidth: 2,
                    borderRadius: 10
                }]
            };

            if (charts.comparison) {
                charts.comparison.destroy();
            }

            charts.comparison = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2149',
                            titleColor: '#ffffff',
                            bodyColor: '#a5b4fc',
                            borderColor: '#00d4ff',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#a5b4fc',
                                font: {
                                    family: 'Outfit'
                                },
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#a5b4fc',
                                font: {
                                    family: 'Outfit',
                                    size: 13
                                }
                            }
                        }
                    }
                }
            });
        }

        // Trend Chart (Line)
        function updateTrendChart() {
            const ctx = document.getElementById('trendChart');
            
            // Group by month
            const monthlyData = {};
            transactions.forEach(t => {
                const month = new Date(t.date).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expenses: 0 };
                }
                if (t.type === 'income') {
                    monthlyData[month].income += t.amount;
                } else {
                    monthlyData[month].expenses += t.amount;
                }
            });

            if (Object.keys(monthlyData).length === 0) {
                if (charts.trend) charts.trend.destroy();
                return;
            }

            const labels = Object.keys(monthlyData);
            const incomeData = labels.map(m => monthlyData[m].income);
            const expenseData = labels.map(m => monthlyData[m].expenses);

            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Income',
                        data: incomeData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    },
                    {
                        label: 'Expenses',
                        data: expenseData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }
                ]
            };

            if (charts.trend) {
                charts.trend.destroy();
            }

            charts.trend = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#a5b4fc',
                                padding: 15,
                                font: {
                                    family: 'Outfit'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a2149',
                            titleColor: '#ffffff',
                            bodyColor: '#a5b4fc',
                            borderColor: '#00d4ff',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#a5b4fc',
                                font: {
                                    family: 'Outfit'
                                },
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#a5b4fc',
                                font: {
                                    family: 'Outfit'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Income Chart (Pie)
        function updateIncomeChart() {
            const ctx = document.getElementById('incomeChart');
            const incomeByCategory = {};
            
            transactions.filter(t => t.type === 'income').forEach(t => {
                incomeByCategory[t.category] = (incomeByCategory[t.category] || 0) + t.amount;
            });

            if (Object.keys(incomeByCategory).length === 0) {
                if (charts.income) charts.income.destroy();
                return;
            }

            const data = {
                labels: Object.keys(incomeByCategory),
                datasets: [{
                    data: Object.values(incomeByCategory),
                    backgroundColor: [
                        '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6',
                        '#ec4899', '#14b8a6', '#f97316', '#06b6d4'
                    ],
                    borderWidth: 0
                }]
            };

            if (charts.income) {
                charts.income.destroy();
            }

            charts.income = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#a5b4fc',
                                padding: 15,
                                font: {
                                    size: 11,
                                    family: 'Outfit'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a2149',
                            titleColor: '#ffffff',
                            bodyColor: '#a5b4fc',
                            borderColor: '#00d4ff',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.parsed.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Budget Overview
        function updateBudgetOverview() {
            const expensesByCategory = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });

            if (Object.keys(expensesByCategory).length === 0) {
                document.getElementById('budgetOverview').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p class="empty-text">No expense data to display.</p>
                    </div>
                `;
                return;
            }

            const sortedCategories = Object.entries(expensesByCategory).sort((a, b) => b[1] - a[1]);
            const totalExpenses = Object.values(expensesByCategory).reduce((a, b) => a + b, 0);

            document.getElementById('budgetOverview').innerHTML = sortedCategories.map(([category, amount]) => {
                const percentage = (amount / totalExpenses * 100);
                const barClass = percentage > 80 ? 'danger' : percentage > 60 ? 'warning' : '';
                
                return `
                    <div class="budget-item">
                        <div class="budget-header">
                            <div class="budget-category">
                                ${category}
                            </div>
                            <div class="budget-amounts">
                                <div class="budget-spent">$${amount.toFixed(2)}</div>
                                <div class="budget-total">${percentage.toFixed(1)}% of total</div>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill ${barClass}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update all UI
        function updateUI() {
            updateDashboard();
            updateTransactionList();
            updateCharts();
            updateBudgetList();
            updateMonthComparison();
            checkBudgetAlerts();
            populateCategoryDetailSelector();
        }

        // Tab Switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'spending') {
                document.getElementById('spendingTab').classList.add('active');
            } else if (tabName === 'budgets') {
                document.getElementById('budgetsTab').classList.add('active');
                updateBudgetList();
            } else if (tabName === 'comparison') {
                document.getElementById('comparisonTab').classList.add('active');
                updateMonthComparison();
            }
        }

        // Budget Management
        function openBudgetModal(category = '') {
            document.getElementById('budgetModal').classList.add('active');
            const select = document.getElementById('budgetCategory');
            select.innerHTML = '<option value="">Select Category</option>';
            
            categories.expense.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === category) option.selected = true;
                select.appendChild(option);
            });

            if (category && budgets[category]) {
                document.getElementById('budgetAmount').value = budgets[category];
            } else {
                document.getElementById('budgetAmount').value = '';
            }
        }

        function closeBudgetModal() {
            document.getElementById('budgetModal').classList.remove('active');
            document.getElementById('budgetForm').reset();
        }

        // Handle budget form
        document.getElementById('budgetForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);
            
            budgets[category] = amount;
            saveBudgets();
            closeBudgetModal();
            updateBudgetList();
            updateBudgetOverview();
            checkBudgetAlerts();
            showNotification(' Budget set successfully!', 'success');
        });

        // Update Budget List
        function updateBudgetList() {
            const budgetList = document.getElementById('budgetList');
            
            if (Object.keys(budgets).length === 0) {
                budgetList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <p class="empty-text">No budgets set yet. Click the button below to create your first budget!</p>
                    </div>
                    <button class="btn btn-full" onclick="openBudgetModal()" style="margin-top: 20px;">
                         Add Budget
                    </button>
                `;
                return;
            }

            // Calculate spending by category
            const spendingByCategory = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                const currentMonth = new Date().getMonth();
                const transactionMonth = new Date(t.date).getMonth();
                if (currentMonth === transactionMonth) {
                    spendingByCategory[t.category] = (spendingByCategory[t.category] || 0) + t.amount;
                }
            });

            let html = '';
            Object.keys(budgets).forEach(category => {
                const budgetLimit = budgets[category];
                const spent = spendingByCategory[category] || 0;
                const remaining = budgetLimit - spent;
                const percentage = (spent / budgetLimit) * 100;
                const progressClass = percentage >= 100 ? 'danger' : percentage >= 80 ? 'warning' : '';

                html += `
                    <div class="budget-card">
                        <div class="budget-card-header">
                            <div class="budget-category">
                                ${category}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="budget-edit-btn" onclick="openBudgetModal('${category}')">Edit</button>
                                <button class="delete-btn" onclick="deleteBudget('${category}')">Delete</button>
                            </div>
                        </div>
                        <div class="budget-stats">
                            <div class="budget-stat">
                                <div class="budget-stat-label">Budget</div>
                                <div class="budget-stat-value" style="color: var(--accent-info);">$${budgetLimit.toFixed(2)}</div>
                            </div>
                            <div class="budget-stat">
                                <div class="budget-stat-label">Spent</div>
                                <div class="budget-stat-value" style="color: ${percentage >= 100 ? 'var(--accent-danger)' : 'var(--accent-warning)'};">$${spent.toFixed(2)}</div>
                            </div>
                            <div class="budget-stat">
                                <div class="budget-stat-label">Remaining</div>
                                <div class="budget-stat-value" style="color: ${remaining < 0 ? 'var(--accent-danger)' : 'var(--accent-success)'};">$${remaining.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill ${progressClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 10px; color: var(--text-muted); font-size: 0.9em;">
                            ${percentage.toFixed(1)}% used
                        </div>
                    </div>
                `;
            });

            html += `
                <button class="btn btn-full" onclick="openBudgetModal()" style="margin-top: 15px;">
                     Add Another Budget
                </button>
            `;

            budgetList.innerHTML = html;
        }

        function deleteBudget(category) {
            if (confirm(`Are you sure you want to delete the budget for ${category}?`)) {
                delete budgets[category];
                saveBudgets();
                updateBudgetList();
                updateBudgetOverview();
                showNotification(' Budget deleted!', 'success');
            }
        }

        // Month Comparison
        function updateMonthComparison() {
            const comparisonDiv = document.getElementById('monthComparison');
            
            // Get current month and previous month data
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            const currentMonthName = new Date(currentYear, currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const prevMonthName = new Date(prevYear, prevMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Calculate current month stats
            const currentIncome = transactions
                .filter(t => t.type === 'income' && new Date(t.date).getMonth() === currentMonth && new Date(t.date).getFullYear() === currentYear)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const currentExpenses = transactions
                .filter(t => t.type === 'expense' && new Date(t.date).getMonth() === currentMonth && new Date(t.date).getFullYear() === currentYear)
                .reduce((sum, t) => sum + t.amount, 0);

            // Calculate previous month stats
            const prevIncome = transactions
                .filter(t => t.type === 'income' && new Date(t.date).getMonth() === prevMonth && new Date(t.date).getFullYear() === prevYear)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const prevExpenses = transactions
                .filter(t => t.type === 'expense' && new Date(t.date).getMonth() === prevMonth && new Date(t.date).getFullYear() === prevYear)
                .reduce((sum, t) => sum + t.amount, 0);

            const currentBalance = currentIncome - currentExpenses;
            const prevBalance = prevIncome - prevExpenses;

            // Calculate changes
            const incomeChange = prevIncome !== 0 ? ((currentIncome - prevIncome) / prevIncome) * 100 : 0;
            const expenseChange = prevExpenses !== 0 ? ((currentExpenses - prevExpenses) / prevExpenses) * 100 : 0;
            const balanceChange = prevBalance !== 0 ? ((currentBalance - prevBalance) / prevBalance) * 100 : 0;

            function getChangeHTML(change, value) {
                if (change === 0 || value === 0) {
                    return `<span class="comparison-change neutral"> No change</span>`;
                }
                const isPositive = change > 0;
                return `
                    <span class="comparison-change ${isPositive ? 'positive' : 'negative'}">
                        ${isPositive ? '' : ''} ${Math.abs(change).toFixed(1)}%
                    </span>
                `;
            }

            comparisonDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 16px;">
                        <div style="color: var(--text-muted); margin-bottom: 10px; font-size: 0.9em;">Previous Month</div>
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--accent-secondary);">${prevMonthName}</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 16px;">
                        <div style="color: var(--text-muted); margin-bottom: 10px; font-size: 0.9em;">Current Month</div>
                        <div style="font-size: 1.5em; font-weight: 700; color: var(--accent-primary);">${currentMonthName}</div>
                    </div>
                </div>

                <div class="comparison-card">
                    <div class="comparison-row">
                        <span class="comparison-label"> Total Income</span>
                        <div class="comparison-values">
                            <span class="comparison-value" style="color: var(--text-muted);">$${prevIncome.toFixed(2)}</span>
                            <span style="color: var(--text-muted);"></span>
                            <span class="comparison-value" style="color: var(--accent-success);">$${currentIncome.toFixed(2)}</span>
                            ${getChangeHTML(incomeChange, currentIncome)}
                        </div>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label"> Total Expenses</span>
                        <div class="comparison-values">
                            <span class="comparison-value" style="color: var(--text-muted);">$${prevExpenses.toFixed(2)}</span>
                            <span style="color: var(--text-muted);"></span>
                            <span class="comparison-value" style="color: var(--accent-danger);">$${currentExpenses.toFixed(2)}</span>
                            ${getChangeHTML(expenseChange, currentExpenses)}
                        </div>
                    </div>
                    <div class="comparison-row">
                        <span class="comparison-label"> Net Balance</span>
                        <div class="comparison-values">
                            <span class="comparison-value" style="color: var(--text-muted);">$${prevBalance.toFixed(2)}</span>
                            <span style="color: var(--text-muted);"></span>
                            <span class="comparison-value" style="color: var(--accent-info);">$${currentBalance.toFixed(2)}</span>
                            ${getChangeHTML(balanceChange, currentBalance)}
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: var(--text-primary); margin-bottom: 20px; font-size: 1.2em;"> Category Breakdown</h3>
                    ${getCategoryComparison(currentMonth, currentYear, prevMonth, prevYear)}
                </div>
            `;
        }

        function getCategoryComparison(currentMonth, currentYear, prevMonth, prevYear) {
            const currentCategories = {};
            const prevCategories = {};

            transactions.filter(t => t.type === 'expense').forEach(t => {
                const tMonth = new Date(t.date).getMonth();
                const tYear = new Date(t.date).getFullYear();
                
                if (tMonth === currentMonth && tYear === currentYear) {
                    currentCategories[t.category] = (currentCategories[t.category] || 0) + t.amount;
                } else if (tMonth === prevMonth && tYear === prevYear) {
                    prevCategories[t.category] = (prevCategories[t.category] || 0) + t.amount;
                }
            });

            const allCategories = new Set([...Object.keys(currentCategories), ...Object.keys(prevCategories)]);
            
            if (allCategories.size === 0) {
                return '<div class="empty-state"><p class="empty-text">No expense data to compare</p></div>';
            }

            let html = '<div class="comparison-card">';
            allCategories.forEach(category => {
                const current = currentCategories[category] || 0;
                const prev = prevCategories[category] || 0;
                const change = prev !== 0 ? ((current - prev) / prev) * 100 : (current > 0 ? 100 : 0);

                html += `
                    <div class="comparison-row">
                        <span class="comparison-label">${category}</span>
                        <div class="comparison-values">
                            <span class="comparison-value" style="color: var(--text-muted); font-size: 0.95em;">$${prev.toFixed(2)}</span>
                            <span style="color: var(--text-muted);"></span>
                            <span class="comparison-value" style="font-size: 0.95em;">$${current.toFixed(2)}</span>
                            ${change !== 0 ? `
                                <span class="comparison-change ${change > 0 ? 'negative' : 'positive'}" style="font-size: 0.85em;">
                                    ${change > 0 ? '' : ''} ${Math.abs(change).toFixed(1)}%
                                </span>
                            ` : '<span class="comparison-change neutral" style="font-size: 0.85em;"></span>'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // Alert System
        function checkBudgetAlerts() {
            const newAlerts = [];
            const today = new Date().toDateString();
            
            // Clean up old dismissed alerts (keep only today's)
            const cleanedDismissed = {};
            if (dismissedAlerts[today]) {
                cleanedDismissed[today] = dismissedAlerts[today];
            }
            dismissedAlerts = cleanedDismissed;
            localStorage.setItem('dismissedAlerts', JSON.stringify(dismissedAlerts));
            
            const todayDismissed = dismissedAlerts[today] || [];
            
            // Calculate spending by category for current month
            const spendingByCategory = {};
            const currentMonth = new Date().getMonth();
            
            transactions.filter(t => t.type === 'expense').forEach(t => {
                const transactionMonth = new Date(t.date).getMonth();
                if (currentMonth === transactionMonth) {
                    spendingByCategory[t.category] = (spendingByCategory[t.category] || 0) + t.amount;
                }
            });

            // Check each budget
            Object.keys(budgets).forEach(category => {
                const budgetLimit = budgets[category];
                const spent = spendingByCategory[category] || 0;
                const percentage = (spent / budgetLimit) * 100;

                if (percentage >= 100) {
                    const alertId = `budget-exceeded-${category}`;
                    if (!todayDismissed.includes(alertId)) {
                        newAlerts.push({
                            type: 'danger',
                            icon: '',
                            title: 'Budget Exceeded!',
                            message: `You've exceeded your budget for ${category}. Spent: $${spent.toFixed(2)} / Budget: $${budgetLimit.toFixed(2)}`,
                            id: alertId
                        });
                    }
                } else if (percentage >= 80) {
                    const alertId = `budget-warning-${category}`;
                    if (!todayDismissed.includes(alertId)) {
                        newAlerts.push({
                            type: 'warning',
                            icon: '',
                            title: 'Budget Warning',
                            message: `You're at ${percentage.toFixed(1)}% of your budget for ${category}. Spent: $${spent.toFixed(2)} / Budget: $${budgetLimit.toFixed(2)}`,
                            id: alertId
                        });
                    }
                }
            });

            // Check month-to-month spending increase
            const now = new Date();
            const currentMonth2 = now.getMonth();
            const currentYear = now.getFullYear();
            const prevMonth = currentMonth2 === 0 ? 11 : currentMonth2 - 1;
            const prevYear = currentMonth2 === 0 ? currentYear - 1 : currentYear;

            const currentExpenses = transactions
                .filter(t => t.type === 'expense' && new Date(t.date).getMonth() === currentMonth2 && new Date(t.date).getFullYear() === currentYear)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const prevExpenses = transactions
                .filter(t => t.type === 'expense' && new Date(t.date).getMonth() === prevMonth && new Date(t.date).getFullYear() === prevYear)
                .reduce((sum, t) => sum + t.amount, 0);

            if (prevExpenses > 0) {
                const expenseIncrease = ((currentExpenses - prevExpenses) / prevExpenses) * 100;
                if (expenseIncrease > 20) {
                    const alertId = 'spending-increase';
                    if (!todayDismissed.includes(alertId)) {
                        newAlerts.push({
                            type: 'warning',
                            icon: '',
                            title: 'Spending Increased',
                            message: `Your expenses are ${expenseIncrease.toFixed(1)}% higher than last month. Current: $${currentExpenses.toFixed(2)}, Previous: $${prevExpenses.toFixed(2)}`,
                            id: alertId
                        });
                    }
                } else if (expenseIncrease < -20) {
                    const alertId = 'spending-decrease';
                    if (!todayDismissed.includes(alertId)) {
                        newAlerts.push({
                            type: 'success',
                            icon: '',
                            title: 'Great Progress!',
                            message: `You've reduced your expenses by ${Math.abs(expenseIncrease).toFixed(1)}% compared to last month! Keep it up!`,
                            id: alertId
                        });
                    }
                }
            }

            // Update alerts and render
            alerts = newAlerts;
            renderAlerts();
        }

        function dismissAlert(index) {
            const alert = alerts[index];
            if (alert && alert.id) {
                // Mark this alert as dismissed for today
                const today = new Date().toDateString();
                if (!dismissedAlerts[today]) {
                    dismissedAlerts[today] = [];
                }
                dismissedAlerts[today].push(alert.id);
                localStorage.setItem('dismissedAlerts', JSON.stringify(dismissedAlerts));
                
                // Animate and remove
                const alertElements = document.querySelectorAll('.alert');
                if (alertElements[index]) {
                    alertElements[index].style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => {
                        alerts.splice(index, 1);
                        renderAlerts();
                    }, 300);
                }
            }
        }

        // Render alerts without recalculating
        function renderAlerts() {
            const alertContainer = document.getElementById('alertContainer');
            
            if (alerts.length === 0) {
                alertContainer.innerHTML = '';
                return;
            }

            alertContainer.innerHTML = alerts.map((alert, index) => `
                <div class="alert ${alert.type}" data-alert-id="${alert.id}">
                    <div class="alert-header">
                        <div style="display: flex; align-items: center;">
                            <span class="alert-icon">${alert.icon}</span>
                            <span class="alert-title">${alert.title}</span>
                        </div>
                        <button class="alert-close" onclick="dismissAlert(${index})"></button>
                    </div>
                    <div class="alert-message">${alert.message}</div>
                </div>
            `).join('');
        }

        // AI Financial Insights
        async function generateAIInsights() {
            const button = document.getElementById('aiInsightsBtn');
            const panel = document.getElementById('aiInsightsPanel');
            
            if (transactions.length === 0) {
                showNotification(' Add some transactions first to get AI insights!', 'error');
                return;
            }

            // Show loading state
            button.disabled = true;
            button.innerHTML = '<span></span><span>Analyzing...</span>';
            panel.classList.add('active');
            panel.innerHTML = `
                <div class="ai-loading">
                    <div class="ai-loading-spinner"></div>
                    <div class="ai-loading-text">Claude is analyzing your financial data...</div>
                </div>
            `;

            try {
                // Prepare financial summary
                const { income, expenses, balance, savingsRate } = calculateTotals();
                
                // Get spending by category
                const expensesByCategory = {};
                transactions.filter(t => t.type === 'expense').forEach(t => {
                    expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                });

                // Get month-over-month comparison
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;

                const currentExpenses = transactions
                    .filter(t => t.type === 'expense' && new Date(t.date).getMonth() === currentMonth && new Date(t.date).getFullYear() === currentYear)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const prevExpenses = transactions
                    .filter(t => t.type === 'expense' && new Date(t.date).getMonth() === prevMonth && new Date(t.date).getFullYear() === prevYear)
                    .reduce((sum, t) => sum + t.amount, 0);

                // Budget status
                const budgetStatus = Object.keys(budgets).map(category => {
                    const spent = expensesByCategory[category] || 0;
                    const budget = budgets[category];
                    const percentage = (spent / budget) * 100;
                    return { category, spent, budget, percentage };
                });

                // Prepare prompt for Claude
                const prompt = `You are a professional financial advisor. Analyze this financial data and provide personalized, actionable advice.

FINANCIAL SUMMARY:
- Total Income: $${income.toFixed(2)}
- Total Expenses: $${expenses.toFixed(2)}
- Current Balance: $${balance.toFixed(2)}
- Savings Rate: ${savingsRate.toFixed(1)}%

SPENDING BY CATEGORY:
${Object.entries(expensesByCategory).map(([cat, amt]) => `- ${cat}: $${amt.toFixed(2)}`).join('\n')}

BUDGET STATUS:
${budgetStatus.length > 0 ? budgetStatus.map(b => `- ${b.category}: $${b.spent.toFixed(2)} / $${b.budget.toFixed(2)} (${b.percentage.toFixed(1)}% used)`).join('\n') : 'No budgets set'}

MONTH COMPARISON:
- Current month expenses: $${currentExpenses.toFixed(2)}
- Previous month expenses: $${prevExpenses.toFixed(2)}
- Change: ${prevExpenses > 0 ? ((currentExpenses - prevExpenses) / prevExpenses * 100).toFixed(1) : 'N/A'}%

Please provide:
1. **Overall Financial Health**: Brief assessment (2-3 sentences)
2. **Key Insights**: 3-4 specific observations about spending patterns
3. **Recommendations**: 3-5 actionable steps to improve finances
4. **Warnings**: Any concerning trends or budget issues

Format your response in clear sections with emojis. Be specific, encouraging, and actionable.`;

                // Call Claude API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get AI insights');
                }

                const data = await response.json();
                const aiResponse = data.content[0].text;

                // Display insights
                panel.innerHTML = `
                    <div class="ai-insights-header">
                        <div class="ai-insights-title">
                             AI Financial Analysis
                            <span class="ai-badge">Powered by Claude</span>
                        </div>
                    </div>
                    <div class="ai-insights-content">
                        ${formatAIResponse(aiResponse)}
                    </div>
                `;

                showNotification(' AI analysis completed!', 'success');

            } catch (error) {
                console.error('AI Insights Error:', error);
                panel.innerHTML = `
                    <div class="insight-card warning">
                        <h3> AI Analysis Feature Note</h3>
                        <p><strong>This feature requires Claude API access.</strong></p>
                        <p style="margin-top: 15px;">To enable AI-powered insights, you would need to:</p>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>Get an API key from <a href="https://console.anthropic.com" target="_blank" style="color: #8b5cf6;">console.anthropic.com</a></li>
                            <li>The API analyzes your data securely without storing it</li>
                        </ul>
                        
                        <div style="margin-top: 25px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--accent-info);">
                            <h4 style="color: var(--text-primary); margin-bottom: 15px;"> Manual Insights Based on Your Data:</h4>
                            ${generateManualInsights()}
                        </div>
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.innerHTML = '<span></span><span>Get AI Analysis</span>';
            }
        }

        // Generate manual insights without AI
        function generateManualInsights() {
            const { income, expenses, balance, savingsRate } = calculateTotals();
            
            // Get top spending categories
            const expensesByCategory = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });
            
            const topCategories = Object.entries(expensesByCategory)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);

            // Month comparison
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;

            const currentExpenses = transactions
                .filter(t => t.type === 'expense' && new Date(t.date).getMonth() === currentMonth && new Date(t.date).getFullYear() === currentYear)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const prevExpenses = transactions
                .filter(t => t.type === 'expense' && new Date(t.date).getMonth() === prevMonth && new Date(t.date).getFullYear() === prevYear)
                .reduce((sum, t) => sum + t.amount, 0);

            const expenseChange = prevExpenses > 0 ? ((currentExpenses - prevExpenses) / prevExpenses * 100) : 0;

            // Budget analysis
            const budgetIssues = Object.keys(budgets).filter(category => {
                const spent = expensesByCategory[category] || 0;
                const budget = budgets[category];
                return (spent / budget) >= 0.8;
            });

            let insights = '<div style="color: var(--text-secondary); line-height: 1.8;">';
            
            // Financial health
            insights += `<p><strong style="color: var(--text-primary);"> Financial Overview:</strong><br>`;
            insights += `Income: $${income.toFixed(2)} | Expenses: $${expenses.toFixed(2)} | Balance: $${balance.toFixed(2)}<br>`;
            insights += `Savings Rate: ${savingsRate.toFixed(1)}%</p>`;

            // Top spending
            if (topCategories.length > 0) {
                insights += `<p style="margin-top: 15px;"><strong style="color: var(--text-primary);"> Top Spending Categories:</strong></p>`;
                insights += '<ul style="margin-left: 20px;">';
                topCategories.forEach(([cat, amt]) => {
                    const pct = (amt / expenses * 100).toFixed(1);
                    insights += `<li>${cat}: $${amt.toFixed(2)} (${pct}% of total expenses)</li>`;
                });
                insights += '</ul>';
            }

            // Month comparison
            if (prevExpenses > 0) {
                insights += `<p style="margin-top: 15px;"><strong style="color: var(--text-primary);"> Month-over-Month:</strong><br>`;
                if (expenseChange > 0) {
                    insights += `Spending increased by ${expenseChange.toFixed(1)}% compared to last month`;
                } else if (expenseChange < 0) {
                    insights += `Great! Spending decreased by ${Math.abs(expenseChange).toFixed(1)}% compared to last month`;
                } else {
                    insights += `Spending is stable compared to last month`;
                }
                insights += `</p>`;
            }

            // Budget warnings
            if (budgetIssues.length > 0) {
                insights += `<p style="margin-top: 15px;"><strong style="color: var(--accent-warning);"> Budget Alerts:</strong><br>`;
                insights += `${budgetIssues.length} categor${budgetIssues.length > 1 ? 'ies' : 'y'} at or exceeding 80% of budget: ${budgetIssues.join(', ')}</p>`;
            }

            // Simple recommendations
            insights += `<p style="margin-top: 15px;"><strong style="color: var(--text-primary);"> Quick Tips:</strong></p>`;
            insights += '<ul style="margin-left: 20px;">';
            
            if (savingsRate < 20) {
                insights += '<li>Try to increase your savings rate to at least 20% of income</li>';
            }
            if (topCategories.length > 0 && topCategories[0][1] / expenses > 0.3) {
                insights += `<li>Consider reducing ${topCategories[0][0]} spending - it\'s your largest expense</li>`;
            }
            if (expenseChange > 15) {
                insights += '<li>Your spending is trending upward - review recent purchases</li>';
            }
            if (budgetIssues.length > 0) {
                insights += '<li>Review and adjust budgets for categories that are close to limits</li>';
            }
            if (balance < expenses) {
                insights += '<li>Build an emergency fund equal to 3-6 months of expenses</li>';
            }
            
            insights += '</ul></div>';
            
            return insights;
        }

        function formatAIResponse(text) {
            // Convert markdown-style formatting to HTML
            let html = text;
            
            // Bold text
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Headers
            html = html.replace(/###\s+(.*?)(\n|$)/g, '<h3>$1</h3>');
            html = html.replace(/##\s+(.*?)(\n|$)/g, '<h3>$1</h3>');
            
            // Line breaks
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n-\s/g, '</p><li>');
            html = html.replace(/\n\d+\.\s/g, '</p><li>');
            
            // Wrap in paragraphs
            html = '<p>' + html + '</p>';
            
            // Clean up
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><h3>/g, '<h3>');
            html = html.replace(/<\/h3><\/p>/g, '</h3>');
            html = html.replace(/<p><li>/g, '<ul><li>');
            html = html.replace(/<\/p>$/g, '</ul>');
            
            return html;
        }

        // User Name Management
        function updateUserNameDisplay() {
            const userNameSpan = document.getElementById('userName');
            if (userName) {
                userNameSpan.textContent = `Welcome back, ${userName}! `;
                userNameSpan.style.color = 'var(--accent-primary)';
            } else {
                userNameSpan.textContent = 'Click to set your name';
                userNameSpan.style.color = 'var(--text-muted)';
            }
        }

        function editUserName() {
            document.getElementById('userNameModal').classList.add('active');
            document.getElementById('userNameInput').value = userName;
            document.getElementById('userNameInput').focus();
        }

        function closeUserNameModal() {
            document.getElementById('userNameModal').classList.remove('active');
        }

        // Handle user name form
        document.getElementById('userNameForm').addEventListener('submit', function(e) {
            e.preventDefault();
            userName = document.getElementById('userNameInput').value.trim();
            if (userName) {
                localStorage.setItem('userName', userName);
                updateUserNameDisplay();
                closeUserNameModal();
                showNotification(` Welcome, ${userName}!`, 'success');
            }
        });

        // ============================================
        // CATEGORY DETAIL VIEW
        // ============================================

        function populateCategoryDetailSelector() {
            const categorySelect = document.getElementById('categoryDetailSelect');
            
            // Get all expense categories that have transactions
            const categoriesWithTransactions = new Set();
            transactions.filter(t => t.type === 'expense').forEach(t => {
                categoriesWithTransactions.add(t.category);
            });

            categorySelect.innerHTML = '<option value="">Choose a category...</option>';
            
            Array.from(categoriesWithTransactions).sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        function populateMonthSelector() {
            const monthSelector = document.getElementById('monthSelector');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentDate = new Date();
            
            // Get all unique year-month combinations from transactions
            const availableMonths = new Set();
            transactions.forEach(t => {
                const date = new Date(t.date);
                const key = `${date.getFullYear()}-${date.getMonth()}`;
                availableMonths.add(key);
            });

            // Generate last 12 months
            monthSelector.innerHTML = '';
            for (let i = 11; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth();
                const key = `${year}-${month}`;
                
                const button = document.createElement('button');
                button.className = 'month-btn';
                button.textContent = `${months[month]} ${year}`;
                button.onclick = () => selectMonth(month, year);
                
                // Highlight current month
                if (month === selectedMonth && year === selectedYear) {
                    button.classList.add('active');
                }
                
                // Disable if no transactions
                if (!availableMonths.has(key)) {
                    button.style.opacity = '0.3';
                    button.style.cursor = 'not-allowed';
                    button.disabled = true;
                }
                
                monthSelector.appendChild(button);
            }
        }

        function selectMonth(month, year) {
            selectedMonth = month;
            selectedYear = year;
            
            // Update button states
            document.querySelectorAll('.month-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateCategoryDetail();
        }

        function updateCategoryDetail() {
            const category = document.getElementById('categoryDetailSelect').value;
            
            if (!category) {
                document.getElementById('monthSelectorContainer').style.display = 'none';
                document.getElementById('categoryDetailContent').innerHTML = '';
                return;
            }

            selectedCategory = category;
            document.getElementById('monthSelectorContainer').style.display = 'block';
            populateMonthSelector();
            displayCategoryDetail();
        }

        function displayCategoryDetail() {
            if (!selectedCategory) return;

            const contentDiv = document.getElementById('categoryDetailContent');
            
            // Filter transactions for selected category and month
            const filteredTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return t.type === 'expense' &&
                       t.category === selectedCategory &&
                       date.getMonth() === selectedMonth &&
                       date.getFullYear() === selectedYear;
            });

            if (filteredTransactions.length === 0) {
                contentDiv.innerHTML = `
                    <div class="no-data-message">
                        <div style="font-size: 3em; margin-bottom: 15px;"></div>
                        <div>No transactions found for ${selectedCategory} in this month</div>
                    </div>
                `;
                return;
            }

            // Calculate statistics
            const total = filteredTransactions.reduce((sum, t) => sum + t.amount, 0);
            const average = total / filteredTransactions.length;
            const highest = Math.max(...filteredTransactions.map(t => t.amount));
            const lowest = Math.min(...filteredTransactions.map(t => t.amount));
            const count = filteredTransactions.length;

            // Sort by date descending
            const sortedTransactions = [...filteredTransactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            contentDiv.innerHTML = `
                <div class="category-detail-card">
                    <div class="category-detail-header">
                        <div class="category-detail-title">
                            ${selectedCategory.split(' ')[0]}
                            ${selectedCategory} - ${months[selectedMonth]} ${selectedYear}
                        </div>
                        <div class="category-detail-total">
                            $${total.toFixed(2)}
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="category-stats">
                        <div class="category-stat-box">
                            <div class="category-stat-label">Total Spent</div>
                            <div class="category-stat-value">$${total.toFixed(2)}</div>
                        </div>
                        <div class="category-stat-box" style="border-left-color: var(--accent-warning);">
                            <div class="category-stat-label">Average</div>
                            <div class="category-stat-value">$${average.toFixed(2)}</div>
                        </div>
                        <div class="category-stat-box" style="border-left-color: var(--accent-danger);">
                            <div class="category-stat-label">Highest</div>
                            <div class="category-stat-value">$${highest.toFixed(2)}</div>
                        </div>
                        <div class="category-stat-box" style="border-left-color: var(--accent-success);">
                            <div class="category-stat-label">Lowest</div>
                            <div class="category-stat-value">$${lowest.toFixed(2)}</div>
                        </div>
                        <div class="category-stat-box" style="border-left-color: var(--accent-primary);">
                            <div class="category-stat-label">Transactions</div>
                            <div class="category-stat-value">${count}</div>
                        </div>
                    </div>

                    <!-- Transactions List -->
                    <div>
                        <h3 style="color: var(--text-primary); margin-bottom: 15px; font-size: 1.1em;">
                             All Transactions (${count})
                        </h3>
                        <div class="category-transactions-list">
                            ${sortedTransactions.map(t => {
                                const hasAttachments = t.attachments && t.attachments.length > 0;
                                return `
                                    <div class="category-transaction-item">
                                        <div class="category-transaction-info">
                                            <div class="category-transaction-name">
                                                ${t.name}
                                                ${hasAttachments ? `<span class="attachment-count">${t.attachments.length}</span>` : ''}
                                            </div>
                                            <div class="category-transaction-date">
                                                ${new Date(t.date).toLocaleDateString('en-US', { 
                                                    weekday: 'short',
                                                    month: 'short', 
                                                    day: 'numeric',
                                                    year: 'numeric' 
                                                })}
                                            </div>
                                        </div>
                                        <div class="category-transaction-amount">
                                            $${t.amount.toFixed(2)}
                                        </div>
                                        ${hasAttachments ? `
                                            <button class="budget-edit-btn" onclick="openViewer(${t.id})" style="margin-left: 10px;">
                                                 View
                                            </button>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize
        updateUserNameDisplay();
        updateUI();

        // Export Data
        function exportData() {
            const dataToExport = {
                transactions: transactions,
                budgets: budgets,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `financeflow-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // Show success notification
            showNotification(' Data exported successfully!', 'success');
        }

        // Import Modal Functions
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importSuccess').classList.remove('show');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        // Clear Modal Functions
        function openClearModal() {
            document.getElementById('clearModal').classList.add('active');
        }

        function closeClearModal() {
            document.getElementById('clearModal').classList.remove('active');
        }

        // File Upload Handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        function handleFileUpload(file) {
            if (file.type !== 'application/json') {
                showNotification(' Please upload a valid JSON file!', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.transactions || !Array.isArray(importedData.transactions)) {
                        throw new Error('Invalid data format');
                    }

                    // Import the data
                    transactions = importedData.transactions;
                    budgets = importedData.budgets || {};
                    saveTransactions();
                    saveBudgets();
                    updateUI();

                    // Show success message
                    document.getElementById('importSuccess').classList.add('show');
                    
                    setTimeout(() => {
                        closeImportModal();
                    }, 2000);

                    showNotification(' Data imported successfully!', 'success');
                } catch (error) {
                    showNotification(' Invalid file format! Please upload a valid FinanceFlow backup file.', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Clear All Data
        function clearAllData() {
            transactions = [];
            budgets = {};
            saveTransactions();
            saveBudgets();
            updateUI();
            closeClearModal();
            showNotification(' All data has been cleared!', 'success');
        }

        // Notification System
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'rgba(16, 185, 129, 0.9)' : 'rgba(239, 68, 68, 0.9)'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // Auto-backup reminder (once a month)
        function checkBackupReminder() {
            const lastBackup = localStorage.getItem('lastBackupReminder');
            const now = new Date();
            
            if (!lastBackup) {
                localStorage.setItem('lastBackupReminder', now.toISOString());
                return;
            }

            const lastBackupDate = new Date(lastBackup);
            const daysSinceLastBackup = Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24));

            if (daysSinceLastBackup >= 30 && transactions.length > 0) {
                setTimeout(() => {
                    showNotification(' Reminder: Back up your data! Click Export Data button.', 'success');
                    localStorage.setItem('lastBackupReminder', now.toISOString());
                }, 3000);
            }
        }

        // Check backup reminder on load
        checkBackupReminder();
    </script>
</body>
</html>